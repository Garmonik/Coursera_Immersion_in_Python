Клиент для отправки метрик<a name="TOP"></a>
===================

В крупных проектах, с большим количеством пользователей, необходимо тщательно наблюдать за всеми процессами, происходящими в нем. Информация о процессах может быть представлена различными численными показателями, например: количество запросов к вашему приложению, время ответа вашего сервиса на каждый запрос, количество пользователей в сутки и другие. Эти различные численные показатели мы будем называть метриками.

Для сбора, хранения и отображения подобных метрик существуют готовые решения, например ***Graphite***, ***InfluxDB***. Мы в рамках курса разработаем свою систему для сбора и хранения метрик, основанную на клиент-серверной архитектуре.

На этой неделе мы начнем с разработки клиента для отправки и получения метрик. На следующей неделе, в качестве финального задания, вам будет предложено реализовать сервер для хранения метрик.
Протокол взаимодействия

Прежде, чем приступить к описанию задания, рассмотрим протокол взаимодействия, по которому будет происходить обмен данными между клиентом и сервером.

Клиент и сервер взаимодействуют между собой по простому текстовому протоколу через TCP сокеты. Текстовый протокол имеет главное преимущество – наглядность, можно просматривать диалог взаимодействия клиентской и серверной стороны без использования дополнительных инструментов.

***Общий формат запросов и ответов.***

Протокол поддерживает два вида запросов к серверу со стороны клиента:

- отправка данных для сохранения их на сервере

- получения сохраненных данных

***Общий формат запроса клиента:***

```Python
<команда> <данные запроса><\n>
```

где:

- ***<команда>*** - команда сервера (команда может принимать одно из двух значений: ***put*** — сохранить данные на сервере, ***get*** — вернуть сохраненные данные с сервера),

- ***<данные запроса>*** - данные запроса (их формат мы подробно разберем ниже в примере),

- ***<\n>*** - символ переноса строки.

Обратим ваше внимание на пробел между командой и данными запроса и его отсутствием между данными и символом перевода на новую строку.

***Общий формат ответов сервера:***

```Python
<статус ответа><\n><данные ответа><\n\n>
```

где:

- ***<статус ответа>*** - статус выполнения команды, допустимы два варианта: ***«ok»*** - команда успешно выполнена на сервере и ***«error»*** - выполнение команды завершилось ошибкой

- ***<данные ответа>*** - не обязательное поле (формат ответа и случаи его отсутствия будут рассмотрены в примере ниже)

- ***<\n\n>*** - два символа переноса строки.

Обратите внимание, что статус ответа и данные ответа разделены символом перевода строки ***<\n>***.

Пример взаимодействия сервера и клиента.

Для наглядности рассмотрим протокол взаимодействия между клиентом и сервером на конкретном примере. В примере мы будем, собирать данные о работе операционной системы: ***cpu*** (загрузка процессора), ***usage*** (потребление памяти), ***disk_usage*** (потребление места на жестком диске), ***network_usage*** (статистика сетевых интерфейсов). Такие данные могут понадобится для контроля загрузки серверов и прогноза по расширению парка железа компании - проще говоря для мониторинга.

Какие данные мы будем сохранять?

Для каждой метрики (***<key>***) мы будем хранить данные о ее значениях (***<value>***) и времени, когда производилось измерение (***<timestamp>***) . Поскольку, в реальной жизни серверов может быть несколько, необходимо различать данные полученные от разных серверов (в нашем примере имеются в наличии два сервера ***palm*** и ***eardrum***). Договоримся об именовании метрик, название метрики ***<key>*** в примере мы будем определять их по правилу:

```Python
<название сервера>.<название данных>
```
  
Примеры названий метрик: ***"palm.cpu"***, ***"eardrum.memory"***.

Таким образом на сервере по каждому ключу будет сохранятся список данных конкретных измерений (пара: значение, время измерения).

***Обратим ваше внимание, на то что названия метрик могут быть произвольными и отличаться от тех, что используются в данном примере (название метрики не обязательно должно быть составным и иметь точку в названии).***

***Запросы клиента.***

Рассмотрим пример отправки на сервер данных для сохранения. Пусть у нас имеются данные измерений - загрузка процессора ***«cpu»*** на сервере ***"palm"*** во время ***1150864247*** была равна ***23.7*** процента. Строка запроса в этом случае будет иметь вид:
  

```Python
put palm.cpu 23.7 1150864247\n
```
  
В запросе на сохранение мы можем передать данные только об одном измерении.

Чтобы получить с сервера данные, сохраненные по ключу «palm.cpu», необходимо в данных запроса просто передать имя ключа:
  
```Python
get palm.cpu\n
```

Для случая, когда необходимо получить все хранимые на сервере данные, в качестве ключа используется символ звездочки «*». Пример строки запроса: 

```Python
get *\n
```
  
Ответы сервера.

Допустим, что на сервере хранятся данные: 
  
key          | value | timestamp  
-----------------------------------

"palm.cpu"    |  2.0  | 1150864247

"palm.cpu"    |  0.5  | 1150864248

"eardrum.cpu" |  3.0  | 1150864250
  
Тогда в ответ на запрос о получении данных по ключу ***"palm.cpu"*** сервер отправит строку:
  
```Python
ok\npalm.cpu 2.0 1150864247\npalm.cpu 0.5 1150864248\n\n
```
  
Данные ответа содержат данные о каждой сохраненной записи с ключом ***"palm.cpu"*** (метрика, значение, временная метка разделенные пробелом), которые разделены символом перевода строки ***«\n»***.

Строка ответа сервера на запрос о получении всех хранящихся на сервере данных (в качестве ключа передано ***«*»***) в нашем случае будет таким:
